<!DOCTYPE html>
<html>

<head>
  <title>Enabling parallelization | C++React</title>
  <link rel="icon" type="image/png" href="../media/favicon.png">
  <link rel="stylesheet" href="../styles/design.css">
  <link rel="stylesheet" href="../styles/syntax.css">
  <script src="../scripts/jquery-1.11.1.min.js"></script>
  <script src="../scripts/jquery.fastLiveFilter.js"></script>
</head>

<body>
<div id="nav_panel_container">
  <div id="nav_panel_header">
    <input id="api_search" class="search_input" placeholder="Type to filter">
  </div>
  <div id="nav_panel_body">
    <ul id="api_list">
      <li class="api_group"><a class="group_link" href="../reference/Algorithm.h.html">Algorithm.h</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Algorithm.h/Hold.html"><img class="entity_icon" src="../media/icon_func.png" /> Hold</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Monitor.html"><img class="entity_icon" src="../media/icon_func.png" /> Monitor</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Iterate.html"><img class="entity_icon" src="../media/icon_func.png" /> Iterate</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Snapshot.html"><img class="entity_icon" src="../media/icon_func.png" /> Snapshot</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Pulse.html"><img class="entity_icon" src="../media/icon_func.png" /> Pulse</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Changed.html"><img class="entity_icon" src="../media/icon_func.png" /> Changed</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/ChangedTo.html"><img class="entity_icon" src="../media/icon_func.png" /> ChangedTo</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Domain.h.html">Domain.h</a></li>
      <!-- <li class="api_subgroup">Constants</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/WeightHint.html"><img class="entity_icon" src="../media/icon_enum.png" /> WeightHint</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/Continuation.html"><img class="entity_icon" src="../media/icon_class.png" /> Continuation</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/TransactionStatus.html"><img class="entity_icon" src="../media/icon_class.png" /> TransactionStatus</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/DoTransaction.html"><img class="entity_icon" src="../media/icon_func.png" /> DoTransaction</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/AsyncTransaction.html"><img class="entity_icon" src="../media/icon_func.png" /> AsyncTransaction</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/MakeContinuation.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeContinuation</a></li>
      <!-- <li class="api_subgroup">Macros</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/REACTIVE_DOMAIN.html"><img class="entity_icon" src="../media/icon_macro.png" /> REACTIVE_DOMAIN</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/USING_REACTIVE_DOMAIN.html"><img class="entity_icon" src="../media/icon_macro.png" /> USING_REACTIVE_DOMAIN</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Event.h.html">Event.h</a></li>
      <!-- <li class="api_subgroup">Constants</li> -->
      <li><a class="ref_link" href="../reference/Event.h/Token.html"><img class="entity_icon" src="../media/icon_enum.png" /> Token</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Event.h/Events.html"><img class="entity_icon" src="../media/icon_class.png" /> Events</a></li>
      <li><a class="ref_link" href="../reference/Event.h/EventSource.html"><img class="entity_icon" src="../media/icon_class.png" /> EventSource</a></li>
      <li><a class="ref_link" href="../reference/Event.h/TempEvents.html"><img class="entity_icon" src="../media/icon_class.png" /> TempEvents</a></li>
      <li><a class="ref_link" href="../reference/Event.h/EventRange.html"><img class="entity_icon" src="../media/icon_class.png" /> EventRange</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Event.h/MakeEventSource.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeEventSource</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Merge.html"><img class="entity_icon" src="../media/icon_func.png" /> Merge</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Filter.html"><img class="entity_icon" src="../media/icon_func.png" /> Filter</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Transform.html"><img class="entity_icon" src="../media/icon_func.png" /> Transform</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Process.html"><img class="entity_icon" src="../media/icon_func.png" /> Process</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Join.html"><img class="entity_icon" src="../media/icon_func.png" /> Join</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Flatten.html"><img class="entity_icon" src="../media/icon_func.png" /> Flatten</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Tokenize.html"><img class="entity_icon" src="../media/icon_func.png" /> Tokenize</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Observer.h.html">Observer.h</a></li>
      <!-- <li class="api_subgroup">Constants</li> -->
      <li><a class="ref_link" href="../reference/Observer.h/ObserverAction.html"><img class="entity_icon" src="../media/icon_enum.png" /> ObserverAction</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Observer.h/Observer.html"><img class="entity_icon" src="../media/icon_class.png" /> Observer</a></li>
      <li><a class="ref_link" href="../reference/Observer.h/ScopedObserver.html"><img class="entity_icon" src="../media/icon_class.png" /> ScopedObserver</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Observer.h/Observe.html"><img class="entity_icon" src="../media/icon_func.png" /> Observe</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Reactor.h.html">Reactor.h</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Reactor.h/Reactor.html"><img class="entity_icon" src="../media/icon_class.png" /> Reactor</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Reactor.h/MakeReactor.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeReactor</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Signal.h.html">Signal.h</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Signal.h/Signal.html"><img class="entity_icon" src="../media/icon_class.png" /> Signal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/VarSignal.html"><img class="entity_icon" src="../media/icon_class.png" /> VarSignal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/TempSignal.html"><img class="entity_icon" src="../media/icon_class.png" /> TempSignal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/SignalPack.html"><img class="entity_icon" src="../media/icon_class.png" /> SignalPack</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Signal.h/MakeVar.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeVar</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/MakeSignal.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeSignal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/Flatten.html"><img class="entity_icon" src="../media/icon_func.png" /> Flatten</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/With.html"><img class="entity_icon" src="../media/icon_func.png" /> With</a></li>
      <!-- <li class="api_subgroup">Macros</li> -->
      <li><a class="ref_link" href="../reference/Signal.h/REACTIVE_PTR.html"><img class="entity_icon" src="../media/icon_macro.png" /> REACTIVE_PTR</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/REACTIVE_REF.html"><img class="entity_icon" src="../media/icon_macro.png" /> REACTIVE_REF</a></li>

      <li class="api_group"><a class="group_link" href="../reference/TypeTraits.h.html">TypeTraits.h</a></li>

    </ul>
  </div>
</div>

<script>
    $(function() {
        $("#api_search").fastLiveFilter(
          "#api_list",
          {
            groups: ["api_group", "api_subgroup"]
          });
    });
</script>

<div id="content_panel_container">
  <div id="content_panel_header">
    <span class="header_text">


      <a href="../index.html">Home</a> &#8640;

      <a href="index.html">Tutorials</a> &#8640;


      Enabling parallelization
    </span>
  </div>
  <div class="content_panel_body">


  <h1>Enabling parallelization <span class="type_tag"></span></h1>

    
    <ul>
  <li><a href="Parallelization.html#parallel-updating">Parallel updating</a></li>
  <li><a href="Parallelization.html#concurrent-input">Concurrent input</a></li>
  <li><a href="Parallelization.html#selecting-a-propagation-engine">Selecting a propagation engine</a></li>
</ul>

<h2 id="parallel-updating">Parallel updating</h2>

<p>Enabling parallel propagation of changes - or parallel updating as we refer to it from now on - turns out to be straightforward;
all we have to do is selecting the <code>parallel</code> policy in the domain definition:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &quot;react/Domain.h&quot;</span>
<span class="cp">#include &quot;react/Signal.h&quot;</span>
<span class="cp">#include &quot;react/Event.h&quot;</span>

<span class="n">REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">parallel</span><span class="p">)</span>
<span class="n">USING_REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>

<span class="kt">int</span> <span class="n">calcX</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">calcY</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">calcZ</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span> 

<span class="n">VarSignalT</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">Input</span> <span class="o">=</span> <span class="n">MakeVar</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">SignalT</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>    <span class="n">X</span>     <span class="o">=</span> <span class="n">MakeSignal</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">calcX</span><span class="p">);</span>
<span class="n">SignalT</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>    <span class="n">Y</span>     <span class="o">=</span> <span class="n">MakeSignal</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">calcY</span><span class="p">);</span>
<span class="n">SignalT</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>    <span class="n">Z</span>     <span class="o">=</span> <span class="n">MakeSignal</span><span class="p">(</span><span class="n">With</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">),</span> <span class="n">calcZ</span><span class="p">);</span></code></pre></div>

<p>Assuming <code>calcX</code> and <code>calcY</code> are computationally expensive, they could be re-calculated in parallel after <code>Input</code> has been changed.
How exactly this is handled internally is up to the propagation engine; it’s explained in detail [here].
In summary, the propagation engine will</p>

<ul>
  <li>use TBB tasks to parallelize upates, which in turn are mapped to a thread pool;</li>
  <li>try to identify expensive computations at runtime to determine when parallelization is worthwhile;</li>
  <li>agglomerate computations dynamically to reduce overhead.</li>
</ul>

<h2 id="concurrent-input">Concurrent input</h2>

<p>Parallel updating is <em>internal</em> concurrency, as it may execute multiple updates of the same turn concurrently.
But what we really want there is parallelism - that is, running them on multiple CPUs in parallel.</p>

<p>On the other hand, there’s <em>external</em> concurrency, which is refers to the ability of handling concurrent input.
This is similar to how a concurrent queue supports push and pop operations from multiple threads at the same time.</p>

<p>To enable concurrent input, we use a concurrency policy with the <code>_concurrent</code> suffix:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D1</span><span class="p">,</span> <span class="n">sequential_concurrent</span><span class="p">)</span>
<span class="n">REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D2</span><span class="p">,</span> <span class="n">parallel_concurrent</span><span class="p">)</span>

<span class="n">D1</span><span class="o">::</span><span class="n">EventSourceT</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">Source1</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D1</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">D2</span><span class="o">::</span><span class="n">EventSourceT</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">Source2</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D2</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span></code></pre></div>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">K</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Source1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">Source2</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">f</span><span class="p">);</span></code></pre></div>

<p>Both domains <code>D1</code> and <code>D2</code> now support safe concurrent input, which is independent of whether updates are parallelized or not.</p>

<h2 id="selecting-a-propagation-engine">Selecting a propagation engine</h2>

<p>C++React supports multiple propagation engines which implement different propagation strategies.
So far, we only selected the concurrency policy when defining a domain.
This uses a default engine for that particular policy.</p>

<p>Selecting an engine explicitly is mostly just relevant for parallel updating, as there’s just a single engine that supports the <code>sequential</code> policy.</p>

<p>For <code>parallel</code> (and <code>parallel_concurrent</code>), we have the following options:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D1</span><span class="p">,</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">topological_sort_engine</span><span class="p">)</span>
<span class="n">REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D2</span><span class="p">,</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">PulsecountEngine</span><span class="p">)</span>
<span class="n">REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D3</span><span class="p">,</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">SubtreeEngine</span><span class="p">)</span></code></pre></div>

<p>How exactly each strategy works is explained <a href="../guides/engines/index.html">here</a>.
Since exchanging them is trivial, it’s easy to compare their performance and find the one that works best for a particular scenario.</p>

  </div>
</div>

</body>

</html>