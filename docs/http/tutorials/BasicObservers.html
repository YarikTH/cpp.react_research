<!DOCTYPE html>
<html>

<head>
  <title>Observers | C++React</title>
  <link rel="icon" type="image/png" href="../media/favicon.png">
  <link rel="stylesheet" href="../styles/design.css">
  <link rel="stylesheet" href="../styles/syntax.css">
  <script src="../scripts/jquery-1.11.1.min.js"></script>
  <script src="../scripts/jquery.fastLiveFilter.js"></script>
</head>

<body>
<div id="nav_panel_container">
  <div id="nav_panel_header">
    <input id="api_search" class="search_input" placeholder="Type to filter">
  </div>
  <div id="nav_panel_body">
    <ul id="api_list">
      <li class="api_group"><a class="group_link" href="../reference/Algorithm.h.html">Algorithm.h</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Algorithm.h/Hold.html"><img class="entity_icon" src="../media/icon_func.png" /> Hold</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Monitor.html"><img class="entity_icon" src="../media/icon_func.png" /> Monitor</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Iterate.html"><img class="entity_icon" src="../media/icon_func.png" /> Iterate</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Snapshot.html"><img class="entity_icon" src="../media/icon_func.png" /> Snapshot</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Pulse.html"><img class="entity_icon" src="../media/icon_func.png" /> Pulse</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/Changed.html"><img class="entity_icon" src="../media/icon_func.png" /> Changed</a></li>
      <li><a class="ref_link" href="../reference/Algorithm.h/ChangedTo.html"><img class="entity_icon" src="../media/icon_func.png" /> ChangedTo</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Domain.h.html">Domain.h</a></li>
      <!-- <li class="api_subgroup">Constants</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/WeightHint.html"><img class="entity_icon" src="../media/icon_enum.png" /> WeightHint</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/Continuation.html"><img class="entity_icon" src="../media/icon_class.png" /> Continuation</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/TransactionStatus.html"><img class="entity_icon" src="../media/icon_class.png" /> TransactionStatus</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/DoTransaction.html"><img class="entity_icon" src="../media/icon_func.png" /> DoTransaction</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/AsyncTransaction.html"><img class="entity_icon" src="../media/icon_func.png" /> AsyncTransaction</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/MakeContinuation.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeContinuation</a></li>
      <!-- <li class="api_subgroup">Macros</li> -->
      <li><a class="ref_link" href="../reference/Domain.h/REACTIVE_DOMAIN.html"><img class="entity_icon" src="../media/icon_macro.png" /> REACTIVE_DOMAIN</a></li>
      <li><a class="ref_link" href="../reference/Domain.h/USING_REACTIVE_DOMAIN.html"><img class="entity_icon" src="../media/icon_macro.png" /> USING_REACTIVE_DOMAIN</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Event.h.html">Event.h</a></li>
      <!-- <li class="api_subgroup">Constants</li> -->
      <li><a class="ref_link" href="../reference/Event.h/Token.html"><img class="entity_icon" src="../media/icon_enum.png" /> Token</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Event.h/Events.html"><img class="entity_icon" src="../media/icon_class.png" /> Events</a></li>
      <li><a class="ref_link" href="../reference/Event.h/EventSource.html"><img class="entity_icon" src="../media/icon_class.png" /> EventSource</a></li>
      <li><a class="ref_link" href="../reference/Event.h/TempEvents.html"><img class="entity_icon" src="../media/icon_class.png" /> TempEvents</a></li>
      <li><a class="ref_link" href="../reference/Event.h/EventRange.html"><img class="entity_icon" src="../media/icon_class.png" /> EventRange</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Event.h/MakeEventSource.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeEventSource</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Merge.html"><img class="entity_icon" src="../media/icon_func.png" /> Merge</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Filter.html"><img class="entity_icon" src="../media/icon_func.png" /> Filter</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Transform.html"><img class="entity_icon" src="../media/icon_func.png" /> Transform</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Process.html"><img class="entity_icon" src="../media/icon_func.png" /> Process</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Join.html"><img class="entity_icon" src="../media/icon_func.png" /> Join</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Flatten.html"><img class="entity_icon" src="../media/icon_func.png" /> Flatten</a></li>
      <li><a class="ref_link" href="../reference/Event.h/Tokenize.html"><img class="entity_icon" src="../media/icon_func.png" /> Tokenize</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Observer.h.html">Observer.h</a></li>
      <!-- <li class="api_subgroup">Constants</li> -->
      <li><a class="ref_link" href="../reference/Observer.h/ObserverAction.html"><img class="entity_icon" src="../media/icon_enum.png" /> ObserverAction</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Observer.h/Observer.html"><img class="entity_icon" src="../media/icon_class.png" /> Observer</a></li>
      <li><a class="ref_link" href="../reference/Observer.h/ScopedObserver.html"><img class="entity_icon" src="../media/icon_class.png" /> ScopedObserver</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Observer.h/Observe.html"><img class="entity_icon" src="../media/icon_func.png" /> Observe</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Reactor.h.html">Reactor.h</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Reactor.h/Reactor.html"><img class="entity_icon" src="../media/icon_class.png" /> Reactor</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Reactor.h/MakeReactor.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeReactor</a></li>

      <li class="api_group"><a class="group_link" href="../reference/Signal.h.html">Signal.h</a></li>
      <!-- <li class="api_subgroup">Classes</li> -->
      <li><a class="ref_link" href="../reference/Signal.h/Signal.html"><img class="entity_icon" src="../media/icon_class.png" /> Signal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/VarSignal.html"><img class="entity_icon" src="../media/icon_class.png" /> VarSignal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/TempSignal.html"><img class="entity_icon" src="../media/icon_class.png" /> TempSignal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/SignalPack.html"><img class="entity_icon" src="../media/icon_class.png" /> SignalPack</a></li>
      <!-- <li class="api_subgroup">Functions</li> -->
      <li><a class="ref_link" href="../reference/Signal.h/MakeVar.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeVar</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/MakeSignal.html"><img class="entity_icon" src="../media/icon_func.png" /> MakeSignal</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/Flatten.html"><img class="entity_icon" src="../media/icon_func.png" /> Flatten</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/With.html"><img class="entity_icon" src="../media/icon_func.png" /> With</a></li>
      <!-- <li class="api_subgroup">Macros</li> -->
      <li><a class="ref_link" href="../reference/Signal.h/REACTIVE_PTR.html"><img class="entity_icon" src="../media/icon_macro.png" /> REACTIVE_PTR</a></li>
      <li><a class="ref_link" href="../reference/Signal.h/REACTIVE_REF.html"><img class="entity_icon" src="../media/icon_macro.png" /> REACTIVE_REF</a></li>

      <li class="api_group"><a class="group_link" href="../reference/TypeTraits.h.html">TypeTraits.h</a></li>

    </ul>
  </div>
</div>

<script>
    $(function() {
        $("#api_search").fastLiveFilter(
          "#api_list",
          {
            groups: ["api_group", "api_subgroup"]
          });
    });
</script>

<div id="content_panel_container">
  <div id="content_panel_header">
    <span class="header_text">


      <a href="../index.html">Home</a> &#8640;

      <a href="index.html">Tutorials</a> &#8640;


      Observers
    </span>
  </div>
  <div class="content_panel_body">


  <h1>Observers <span class="type_tag"></span></h1>

    
    <ul>
  <li><a href="BasicObservers.html#creating-subject-bound-observers">Creating subject-bound observers</a></li>
  <li><a href="BasicObservers.html#detach-observers-manually">Detaching observers manually</a></li>
  <li><a href="BasicObservers.html#using-scoped-observers">Using scoped observers</a></li>
  <li><a href="BasicObservers.html#observing-temporary-reactives">Observing temporary reactives</a></li>
</ul>

<h2 id="creating-subject-bound-observers">Creating subject-bound observers</h2>

<p>As mentioned in the previous examples, by default observers are bound to the lifetime of the observed subject.
Here’s another demonstration of this behaviour:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &quot;react/Domain.h&quot;</span>
<span class="cp">#include &quot;react/Event.h&quot;</span>
<span class="cp">#include &quot;react/Observer.h&quot;</span>

<span class="n">REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">sequential</span><span class="p">)</span>
<span class="n">USING_REACTIVE_DOMAIN</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>

<span class="kt">void</span> <span class="n">testFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">trigger</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="n">Observe</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></div>

<p>After leaving <code>testFunc</code>, <code>trigger</code> is destroyed.
This automatically detaches and destroys the observer as well.
We don’t have to worry about resource leaks or that the existence of an observer might prevent the subject from being destroyed.</p>

<h2 id="detaching-observers-manually">Detaching observers manually</h2>

<p>Alternatively, observers can be detached explicitly before the lifetime of their subject ends.
We can either do this externally, or from inside the observer function.</p>

<p>The former is demonstrated here:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">testFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">trigger</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="n">ObserverT</span> <span class="n">obs</span> <span class="o">=</span> <span class="n">Observe</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="p">[]</span> <span class="p">(</span><span class="n">Token</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Triggered&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="n">trigger</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span> <span class="c1">// output: Triggered</span>

    <span class="n">obs</span><span class="p">.</span><span class="n">Detach</span><span class="p">();</span>   <span class="c1">// remove the observer</span>

    <span class="n">trigger</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span> <span class="c1">// no output</span>
<span class="p">}</span></code></pre></div>

<p><code>ObserverT</code> is an alias for <code>Observer&lt;D&gt;</code> defined by <code>USING_REACTIVE_DOMAIN(D)</code>.
The observer handle returned by <code>Observe</code> is stored and by calling its <code>Detach</code> member function, the underlying observer node is destroyed and the handle becomes invalid.</p>

<p>While it exists and has not been invalidated, an observer handle also takes shared ownership of the observed subject, i.e. by saving it, we state our continued interest in subject.
This behaviour comes in handy as shown later.</p>

<p>To create self-detaching observers, the return value of the observer function is changed from  <code>void</code> to <code>ObserverAction</code>:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">testFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">source</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="n">Observe</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="p">[]</span> <span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObserverAction</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">ObserverAction</span><span class="o">::</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Detached&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">ObserverAction</span><span class="o">::</span><span class="n">stop_and_detach</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// output: 3 2 1 Detached</span>

    <span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="c1">// no output</span>
<span class="p">}</span></code></pre></div>

<h2 id="using-scoped-observers">Using scoped observers</h2>

<p>Instead of calling <code>Detach</code> manually, we can utilize the common RAII idiom and transfer ownership of the observer handle to a scope guard:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">testFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">trigger</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="c1">// Start inner scope</span>
    <span class="p">{</span>
        <span class="n">ScopedObserverT</span> <span class="n">scopedObs</span>
        <span class="p">(</span>
            <span class="n">Observe</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="p">[]</span> <span class="p">(</span><span class="n">Token</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Triggered&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">})</span>
        <span class="p">);</span>

        <span class="n">trigger</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span>
        <span class="c1">// output: Triggered</span>
    <span class="p">}</span>
    <span class="c1">// End inner scope</span>

    <span class="n">trigger</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span>
    <span class="c1">// no output</span>
<span class="p">}</span></code></pre></div>

<p>The observer is detached in the destructor of <code>ScopedObserverT</code>.</p>

<h2 id="observing-temporary-reactives">Observing temporary reactives</h2>

<p>One problem of tying the lifetime of the observer to its subject manifests when attempting to do the following:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">testFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">MakeEventSource</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="n">Observe</span><span class="p">(</span><span class="n">Merge</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">),</span> <span class="p">[]</span> <span class="p">(</span><span class="n">Token</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Triggered!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="n">e1</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span> <span class="c1">// no output</span>
    <span class="n">e2</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span> <span class="c1">// no output</span>
<span class="p">}</span></code></pre></div>

<p>The reason this produces no output is that the result of <code>Merge(e1, e2)</code> is destroyed after the call, as nobody takes ownership of it.
Consequently, the observer is destroyed as well.</p>

<p>To prevent this, the merged event stream could be kept in variable.
Alternatively, we can make use of the fact that the observer handle takes ownership of its subject:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">auto</span> <span class="n">obs</span> <span class="o">=</span> <span class="n">Observe</span><span class="p">(</span><span class="n">Merge</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">),</span> <span class="p">[]</span> <span class="p">(</span><span class="n">Token</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Triggered&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">});</span>

<span class="n">e1</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span> <span class="c1">// output: Triggered</span>
<span class="n">e2</span><span class="p">.</span><span class="n">Emit</span><span class="p">();</span> <span class="c1">// output: Triggered</span></code></pre></div>

  </div>
</div>

</body>

</html>